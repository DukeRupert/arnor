# arnor — Project Scope

## Overview

`arnor` is a unified infrastructure management CLI and TUI for managing the full lifecycle of web projects hosted on Hetzner Cloud with DNS managed via Porkbun or Cloudflare. It is the encompassing tool of the Firefly Software infrastructure suite, wrapping `shadowfax`, `gwaihir`, and `fornost` into a single cohesive interface.

Named after the kingdom of Arnor — the realm that administered the north, of which Fornost was the capital.

The primary use case is rapidly deploying static brochure sites and simple web applications for clients: connect a GitHub repo to a VPS and a domain name, and everything else is handled automatically.

## Repository

`github.com/dukerupert/arnor`

## Status

**Planned**

## Technology

- **Language:** Go
- **CLI framework:** Cobra (v1.0.0), with BubbleTea TUI layer added in v2.0.0
- **TUI framework:** BubbleTea + Lipgloss (v2.0.0)
- **Key dependencies:**
  - `github.com/spf13/cobra`
  - `github.com/spf13/viper`
  - `github.com/joho/godotenv`
  - `github.com/charmbracelet/bubbletea` (v2.0.0)
  - `github.com/charmbracelet/lipgloss` (v2.0.0)
  - `github.com/charmbracelet/bubbles` (v2.0.0)

## Suite Components

| Tool | Scope | Repo |
|---|---|---|
| `shadowfax` | Porkbun DNS | `github.com/fireflysoftware/shadowfax` |
| `gwaihir` | Cloudflare DNS | `github.com/fireflysoftware/gwaihir` |
| `fornost` | Hetzner Cloud infrastructure | `github.com/fireflysoftware/fornost` |
| `arnor` | Unified CLI + TUI wrapping all three | `github.com/fireflysoftware/arnor` |

## Configuration

### Environment variables

Loaded from `~/.dotfiles/.env`:

```env
# Porkbun
PORKBUN_API_KEY=pk1_your_api_key
PORKBUN_SECRET_KEY=sk1_your_secret_key

# Cloudflare
CLOUDFLARE_API_TOKEN=your_api_token
CLOUDFLARE_ACCOUNT_ID=your_account_id

# Hetzner (one token per project)
HETZNER_API_TOKEN_PROD=token_for_prod
HETZNER_API_TOKEN_DEV=token_for_dev

# GitHub
GITHUB_TOKEN=your_github_token

# Peon SSH key for VPS setup
PEON_SSH_KEY="-----BEGIN OPENSSH PRIVATE KEY-----
...
-----END OPENSSH PRIVATE KEY-----"
```

### Config file

`~/.config/arnor/config.yaml` — generated by `arnor config init`, not hand-written.

```yaml
hetzner_projects:
  - alias: prod
    token_env: HETZNER_API_TOKEN_PROD
  - alias: dev
    token_env: HETZNER_API_TOKEN_DEV

servers:
  - name: my-vps
    ip: 5.78.89.141
    hetzner_project: prod
    hetzner_id: 12345678

projects:
  - name: myclient
    repo: github.com/fireflysoftware/myclient
    server: my-vps
    environments:
      dev:
        domain: myclient.angmar.dev
        dns_provider: porkbun
        branch: dev
        deploy_path: /opt/myclient-dev
        deploy_user: myclient-dev-deploy
        port: 8081
      prod:
        domain: myclient.com
        dns_provider: cloudflare
        branch: main
        deploy_path: /opt/myclient
        deploy_user: myclient-deploy
        port: 8080

  - name: anotherclient
    repo: github.com/fireflysoftware/anotherclient
    server: my-vps
    environments:
      dev:
        domain: anotherclient.angmar.dev
        dns_provider: porkbun
        branch: dev
        deploy_path: /opt/anotherclient-dev
        deploy_user: anotherclient-dev-deploy
        port: 3001
      prod:
        domain: anotherclient.com
        dns_provider: porkbun
        branch: main
        deploy_path: /opt/anotherclient
        deploy_user: anotherclient-deploy
        port: 3000
```

DNS provider is auto-detected during `arnor config init` by inspecting the domain's nameservers and matching them against known Porkbun and Cloudflare nameserver patterns.

### Environment conventions

- `dev` environment: always a subdomain under `angmar.dev`, DNS on Porkbun, triggered by push to `dev` branch
- `prod` environment: always a root domain supplied by the client, DNS provider auto-detected, triggered by tag on `main` branch
- Ports are allocated per environment — dev and prod run as separate containers on different ports on the same VPS
- Deploy users are separate per environment: `project-dev-deploy` and `project-deploy`

## Project Structure

```
arnor/
├── main.go
├── cmd/
│   ├── root.go           # env loading, cobra setup
│   ├── config.go         # config init, view, edit
│   ├── project.go        # project create, list, view
│   ├── server.go         # server list, view (fornost)
│   ├── dns.go            # dns create, list, delete (shadowfax/gwaihir)
│   └── ssh.go            # ssh key management (fornost)
├── internal/
│   ├── config/
│   │   └── config.go     # config file read/write
│   ├── dns/
│   │   ├── provider.go   # DNS provider interface
│   │   ├── porkbun.go    # shadowfax client adapter
│   │   └── cloudflare.go # gwaihir client adapter
│   ├── hetzner/
│   │   └── client.go     # fornost client adapter
│   ├── caddy/
│   │   └── caddy.go      # caddy config generation
│   └── project/
│       └── setup.go      # project creation orchestration
├── tui/                  # v2.0.0
│   ├── app.go            # bubbletea root model
│   ├── dashboard.go      # server/project overview
│   ├── tasks.go          # task selection menu
│   └── views/
│       ├── servers.go
│       ├── projects.go
│       └── dns.go
├── .env.example
├── ROADMAP.md
└── README.md
```

## Commands

### v1.0.0 — CLI Foundation

#### Config

| Command | Description |
|---|---|
| `arnor config init` | Auto-generate config by querying Hetzner, Porkbun, and Cloudflare APIs |
| `arnor config view` | Print current config |

#### Projects

| Command | Description |
|---|---|
| `arnor project list` | List all configured projects with server, environments, and domains |
| `arnor project view [name]` | Show details for a project including both environments |
| `arnor project create` | Interactive wizard to connect a GitHub repo to a VPS and domain |

#### Servers

| Command | Description |
|---|---|
| `arnor server list` | List all servers across all Hetzner projects |
| `arnor server view [name]` | Show server details including IP, status, location |

#### DNS

| Command | Description |
|---|---|
| `arnor dns list --domain [domain]` | List DNS records, auto-detecting provider |
| `arnor dns create` | Create a DNS record, auto-detecting provider |
| `arnor dns delete` | Delete a DNS record, auto-detecting provider |

#### SSH

| Command | Description |
|---|---|
| `arnor ssh list` | List SSH keys across all Hetzner projects |
| `arnor ssh add` | Upload an SSH key to a Hetzner project |

### v2.0.0 — TUI Layer

Invoking `arnor` with no arguments launches the TUI.

#### TUI Structure

```
┌─ arnor ──────────────────────────────────────────┐
│                                                   │
│  What would you like to do?                       │
│                                                   │
│  ▶ Create a new project                           │
│    View projects                                  │
│    View servers                                   │
│    View DNS records                               │
│    Manage SSH keys                                │
│    Troubleshoot a domain                          │
│                                                   │
└───────────────────────────────────────────────────┘
```

**Task: Create a new project**
A step-by-step wizard:
1. Select or enter a GitHub repo
2. Select a server (list fetched from Hetzner)
3. Select environment to set up: `dev`, `prod`, or `both`
4. Enter domain name(s) — dev defaults to `project.angmar.dev`, prod prompts for client domain
5. Enter port(s)
6. Confirm summary
7. Execute — streaming progress output

**View: Projects**
Table of all projects with name, dev domain, prod domain, server, and a status indicator per environment (is the domain resolving to the right IP?).

**View: Servers**
Table of all Hetzner servers across all projects with IP, status, location, and which projects are hosted on each.

**View: DNS Records**
Select a domain, view all records. Provider auto-detected.

**Troubleshoot a domain**
Given a domain, show:
- Current DNS records and whether they match the expected server IP
- Server status
- Caddy config if accessible
- A pass/fail summary

## DNS Provider Interface

A key architectural decision — `arnor` defines a common interface that both `shadowfax` and `gwaihir` implement, allowing commands to work without knowing which provider is in use:

```go
type DNSProvider interface {
    CreateRecord(domain, name, recordType, content, ttl string) (string, error)
    DeleteRecord(domain, id string) error
    ListRecords(domain string) ([]DNSRecord, error)
}
```

Provider is selected automatically based on the domain's entry in `config.yaml`, or by inspecting nameservers if the domain is not yet in config.

## `arnor project create` — Orchestration Steps

This is the `new-project.sh` replacement. Runs once per environment (`dev`, `prod`, or both).

1. Prompt for GitHub repo, server, environment, domain, port
2. Look up server IP from Hetzner API
3. Detect DNS provider from nameservers
4. Create DockerHub repo via API (once per project, not per environment)
5. SSH into VPS as `peon` — create deploy user, deploy path, docker group membership, SSH keypair
6. Write Caddy config for this environment, restart Caddy
7. Create DNS A record and www CNAME via detected provider
8. Set GitHub Actions secrets via `gh` CLI — secrets are namespaced by environment:
   - `DEV_VPS_USER`, `DEV_VPS_DEPLOY_PATH`, `DEV_VPS_SSH_KEY`
   - `PROD_VPS_USER`, `PROD_VPS_DEPLOY_PATH`, `PROD_VPS_SSH_KEY`
   - `VPS_HOST` and `DOCKERHUB_*` are shared across environments
9. Write project entry to `~/.config/arnor/config.yaml`

## GitHub Actions Workflow

Each project gets two workflow files generated by `arnor project create`:

### `.github/workflows/deploy-dev.yml`
- Trigger: push to `dev` branch
- Steps: run tests → build Docker image → tag as `dev-{sha}` → push to DockerHub → SSH into VPS → pull image → restart container
- Uses: `DEV_VPS_USER`, `DEV_VPS_DEPLOY_PATH`, `DEV_VPS_SSH_KEY`, `VPS_HOST`

### `.github/workflows/deploy-prod.yml`
- Trigger: push of tag matching `v*` on `main` branch
- Steps: run tests → build Docker image → tag as `{version}` → push to DockerHub → SSH into VPS → pull image → restart container
- Uses: `PROD_VPS_USER`, `PROD_VPS_DEPLOY_PATH`, `PROD_VPS_SSH_KEY`, `VPS_HOST`

### Secret naming conventions

| Secret | Scope | Description |
|---|---|---|
| `DOCKERHUB_TOKEN` | shared | DockerHub auth token |
| `DOCKERHUB_USERNAME` | shared | DockerHub username |
| `VPS_HOST` | shared | VPS IP address |
| `DEV_VPS_USER` | dev | Dev deploy username |
| `DEV_VPS_DEPLOY_PATH` | dev | Dev deploy path |
| `DEV_VPS_SSH_KEY` | dev | Dev deploy SSH private key |
| `PROD_VPS_USER` | prod | Prod deploy username |
| `PROD_VPS_DEPLOY_PATH` | prod | Prod deploy path |
| `PROD_VPS_SSH_KEY` | prod | Prod deploy SSH private key |

## Roadmap

### v1.0.0 — CLI Foundation
- Config init and view
- Project list, view, create (dev and prod environments)
- Server list and view
- DNS list, create, delete
- SSH key list and add
- GitHub Actions workflow file generation

### v1.1.0 — Robustness
- `arnor project teardown [name] [--env dev|prod]` — reverse of create
- `arnor domain check [domain]` — verify DNS is pointing to the right place
- Better error handling and recovery in `project create`

### v2.0.0 — TUI
- BubbleTea TUI launched by `arnor` with no arguments
- All v1.0.0 functionality accessible via TUI
- Task-driven workflow with step-by-step wizards
- Dashboard views for servers, projects, DNS with per-environment status indicators

### v2.1.0 — TUI Enhancements
- Troubleshoot domain view
- Streaming progress output during project create
- Inline Caddy config viewer

## Notes for Implementing Agents

- All three component tools (`shadowfax`, `gwaihir`, `fornost`) should be imported as Go packages, not shelled out to as binaries. Their `internal/` client packages are the integration point.
- The DNS provider interface is the most important architectural piece — get this right before wiring up commands.
- `arnor config init` is the entry point for new users — it should be robust, handle missing credentials gracefully, and produce a valid config file with minimal input.
- The TUI layer in v2.0.0 should be a thin wrapper over the same underlying functions used by the CLI — no business logic in the TUI models.
- Design CLI commands with the TUI in mind from v1.0.0 — functions should return structured data, not print directly to stdout, so the TUI can consume them without refactoring.
- Mirror `.env` loading and error handling patterns from `shadowfax` for consistency.
- `peon.sh` is a prerequisite for `arnor project create` — document this clearly and consider adding a preflight check that verifies `peon` exists on the target server before proceeding.
- GitHub Actions workflow files should be generated into `.github/workflows/` in the current repo during `project create` — one file per environment.
- Dev deploys trigger on branch push (no tag required). Prod deploys trigger on semver tags (`v*`) on `main` only.
- Port allocation is the user's responsibility — `arnor` does not auto-assign ports. Document the convention of dev using prod port + 1 as a suggested pattern.
